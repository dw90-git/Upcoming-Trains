<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Train Tracker - Live On-Demand</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            line-height: 1.6;
            color: #333;
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #2c5aa0, #1e3a5f);
            color: white;
            padding: 3rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(44, 90, 160, 0.3);
        }

        .header::before {
            content: '🚂';
            position: absolute;
            font-size: 4rem;
            opacity: 0.1;
            top: 1rem;
            right: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .cost-banner {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);
        }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .card-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c5aa0;
            margin: 0;
        }

        .card-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            color: #495057;
        }

        select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #ced4da;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.2s ease;
        }

        select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-width: 160px;
        }

        .btn:hover {
            background: #1e3a5f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 90, 160, 0.4);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .api-status {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .api-status.testing {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
        }

        .api-status.working {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }

        .api-status.failed {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
        }

        .train-card {
            background: white;
            border: 2px solid #e9ecef;
            border-left: 6px solid #28a745;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .train-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .train-card.delayed {
            border-left-color: #ffc107;
        }

        .train-card.cancelled {
            border-left-color: #dc3545;
        }

        .train-card.fresh {
            border-left-color: #20c997;
            animation: newData 2s ease-out;
        }

        @keyframes newData {
            0% {
                background: #e8f8f3;
            }
            100% {
                background: white;
            }
        }

        .train-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .train-time {
            font-size: 2rem;
            font-weight: 700;
            color: #2c5aa0;
        }

        .train-expected {
            color: #856404;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .train-platform {
            text-align: right;
        }

        .platform-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .platform-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #495057;
        }

        .train-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            font-size: 0.95rem;
        }

        .detail-item strong {
            color: #495057;
        }

        .status-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
            background: white;
            border-radius: 16px;
            border: 2px dashed #ced4da;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #495057;
        }

        .info-panel {
            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
            border: 2px solid #bee5eb;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
            font-size: 0.95rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .info-item strong {
            display: block;
            color: #2c5aa0;
            margin-bottom: 0.5rem;
        }

        .cost-highlight {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 8px;
            padding: 1.5rem;
            color: #0c5460;
            font-weight: 500;
        }

        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header {
                padding: 2rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .card-header,
            .card-body {
                padding: 1.5rem;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .train-header {
                flex-direction: column;
                gap: 1rem;
            }

            .train-platform {
                text-align: left;
            }

            .train-details {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>🚂 UK Live Train Tracker</h1>
        <p>Instant live data • On-demand refresh • Always up-to-date</p>
    </div>

    <div class="cost-banner">
        <strong>💰 COMPLETELY FREE!</strong>
        Zero hosting costs • No API limits • Instant fresh data when you need it
    </div>

    <div id="api-status" class="api-status testing hidden">
        <strong>🔧 API Status:</strong> <span id="api-message">Testing connection...</span>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>🚂 Get Live Train Times</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="route-select">Select your journey:</label>
                <select id="route-select">
                    <option value="WFJ-EUS">🚂 Watford Junction → London Euston</option>
                    <option value="EUS-WFJ">🚂 London Euston → Watford Junction</option>
                    <option value="PAD-RDG">🚂 London Paddington → Reading</option>
                    <option value="RDG-PAD">🚂 Reading → London Paddington</option>
                    <option value="VIC-BTN">🚂 London Victoria → Brighton</option>
                    <option value="BTN-VIC">🚂 Brighton → London Victoria</option>
                    <option value="KGX-YRK">🚂 London King's Cross → York</option>
                    <option value="YRK-KGX">🚂 York → London King's Cross</option>
                    <option value="LST-NRW">🚂 London Liverpool Street → Norwich</option>
                    <option value="NRW-LST">🚂 Norwich → London Liverpool Street</option>
                    <option value="MAN-LIV">🚂 Manchester → Liverpool</option>
                    <option value="LIV-MAN">🚂 Liverpool → Manchester</option>
                    <option value="BHM-EUS">🚂 Birmingham → London Euston</option>
                    <option value="GLC-EDB">🚂 Glasgow Central → Edinburgh</option>
                </select>
            </div>

            <div class="control-group">
                <button class="btn btn-success" id="refresh-btn">
                    <span id="refresh-text">⚡ Get Live Times</span>
                </button>
                <button class="btn btn-secondary" id="test-btn">🔧 Test Connection</button>
            </div>

            <div class="api-status testing" style="margin-top: 1.5rem; margin-bottom: 0;">
                <strong>ℹ️ How it works:</strong> Click "Get Live Times" to fetch the freshest train data directly from the RTT API. 
                No scheduled updates = zero costs and always current information!
            </div>
        </div>
    </div>

    <div id="results"></div>

    <script>
        class LiveTrainTracker {
            constructor() {
                this.currentRoute = null;
                this.lastFetchTime = null;
                this.apiMethod = null;
                this.init();
            }

            async init() {
                console.log('🚂 Live Train Tracker initializing...');

                // Bind events
                document.getElementById('route-select').addEventListener('change', (e) => {
                    this.selectRoute(e.target.value);
                });

                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.fetchLiveData();
                });

                document.getElementById('test-btn').addEventListener('click', () => {
                    this.testConnection();
                });

                // Set default route
                this.selectRoute('WFJ-EUS');

                // Auto-test connection on load
                setTimeout(() => this.testConnection(), 500);

                console.log('✅ Live Train Tracker ready');
            }

            selectRoute(value) {
                const routes = {
                    'WFJ-EUS': { from: 'WFJ', to: 'EUS', name: 'Watford Junction → London Euston' },
                    'EUS-WFJ': { from: 'EUS', to: 'WFJ', name: 'London Euston → Watford Junction' },
                    'PAD-RDG': { from: 'PAD', to: 'RDG', name: 'London Paddington → Reading' },
                    'RDG-PAD': { from: 'RDG', to: 'PAD', name: 'Reading → London Paddington' },
                    'VIC-BTN': { from: 'VIC', to: 'BTN', name: 'London Victoria → Brighton' },
                    'BTN-VIC': { from: 'BTN', to: 'VIC', name: 'Brighton → London Victoria' },
                    'KGX-YRK': { from: 'KGX', to: 'YRK', name: 'London King\'s Cross → York' },
                    'YRK-KGX': { from: 'YRK', to: 'KGX', name: 'York → London King\'s Cross' },
                    'LST-NRW': { from: 'LST', to: 'NRW', name: 'London Liverpool Street → Norwich' },
                    'NRW-LST': { from: 'NRW', to: 'LST', name: 'Norwich → London Liverpool Street' },
                    'MAN-LIV': { from: 'MAN', to: 'LIV', name: 'Manchester → Liverpool' },
                    'LIV-MAN': { from: 'LIV', to: 'MAN', name: 'Liverpool → Manchester' },
                    'BHM-EUS': { from: 'BHM', to: 'EUS', name: 'Birmingham → London Euston' },
                    'GLC-EDB': { from: 'GLC', to: 'EDB', name: 'Glasgow Central → Edinburgh' }
                };

                this.currentRoute = routes[value];
                console.log('📍 Route selected:', this.currentRoute.name);
            }

            async fetchLiveData() {
                if (!this.currentRoute) {
                    this.showStatus('Please select a route first', 'failed');
                    return;
                }

                const refreshBtn = document.getElementById('refresh-btn');
                const refreshText = document.getElementById('refresh-text');

                // Update UI
                refreshBtn.disabled = true;
                refreshText.innerHTML = '⏳ Fetching...';

                this.showStatus('🔄 Fetching live data from RTT API...', 'testing');
                this.showResults(`
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <h3>Fetching Live Data</h3>
                        <p>Getting the latest train times for <strong>${this.currentRoute.name}</strong></p>
                        <small>Direct from RTT API • Always fresh • No caching</small>
                    </div>
                `);

                try {
                    const startTime = Date.now();
                    const data = await this.callTrainAPI(this.currentRoute.from, this.currentRoute.to);
                    const fetchTime = Date.now() - startTime;

                    this.lastFetchTime = new Date();
                    this.displayTrainData(data, fetchTime);

                    this.showStatus(`✅ Fresh data loaded via ${this.apiMethod} in ${fetchTime}ms`, 'working');
                    console.log(`✅ Success: ${data.services?.length || 0} trains found in ${fetchTime}ms`);

                } catch (error) {
                    console.error('❌ API Error:', error);
                    this.showStatus(`❌ Failed: ${error.message}`, 'failed');
                    this.showErrorState(error);
                } finally {
                    refreshBtn.disabled = false;
                    refreshText.innerHTML = '⚡ Refresh Data';
                }
            }

            async callTrainAPI(from, to) {
                const baseUrl = `https://api.rtt.io/api/v1/json/search/${from}/to/${to}`;
                const credentials = btoa('rttapi_daz4590:4b886b4940dfd3dbe7b659004994360ec8a34cbc');

                const methods = [
                    {
                        name: 'AllOrigins Proxy',
                        url: `https://api.allorigins.win/get?url=${encodeURIComponent(baseUrl)}`,
                        unwrap: true
                    },
                    {
                        name: 'Direct API',
                        url: baseUrl,
                        unwrap: false
                    },
                    {
                        name: 'CodeTabs Proxy',
                        url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(baseUrl)}`,
                        unwrap: false
                    }
                ];

                for (const method of methods) {
                    try {
                        console.log(`🔄 Trying ${method.name}...`);

                        const response = await fetch(method.url, {
                            headers: {
                                'Authorization': `Basic ${credentials}`,
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache'
                            },
                            signal: AbortSignal.timeout(15000)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        let data = await response.text();

                        // Handle proxy wrapper
                        if (method.unwrap) {
                            const parsed = JSON.parse(data);
                            if (parsed.contents) {
                                data = parsed.contents;
                            }
                        }

                        const jsonData = JSON.parse(data);
                        this.apiMethod = method.name;
                        return jsonData;

                    } catch (error) {
                        console.log(`❌ ${method.name} failed:`, error.message);
                        continue;
                    }
                }

                throw new Error('All API methods failed - check internet connection');
            }

            displayTrainData(data, fetchTime) {
                if (!data?.services?.length) {
                    this.showResults(`
                        <div class="empty-state">
                            <h3>🚂 No Trains Found</h3>
                            <p>No current services for <strong>${this.currentRoute.name}</strong></p>
                            <p><em>Try a different route or time of day</em></p>
                            <button class="btn btn-success" onclick="trainTracker.fetchLiveData()">
                                🔄 Try Again
                            </button>
                        </div>
                    `);
                    return;
                }

                const trains = data.services
                    .filter(s => s.isPassenger !== false)
                    .slice(0, 10)
                    .map(s => this.formatTrain(s));

                const trainsHtml = trains.map((train, i) => `
                    <div class="train-card ${train.statusClass} ${i < 3 ? 'fresh' : ''}">
                        <div class="train-header">
                            <div>
                                <div class="train-time">${train.scheduledTime}</div>
                                ${train.expectedTime !== train.scheduledTime ? 
                                    `<div class="train-expected">Expected: ${train.expectedTime}</div>` : ''
                                }
                            </div>
                            <div class="train-platform">
                                <div class="platform-label">Platform</div>
                                <div class="platform-number">${train.platform}</div>
                            </div>
                        </div>

                        <div class="train-details">
                            <div class="detail-item">
                                <strong>Operator:</strong><br>
                                ${train.operator}
                            </div>
                            <div class="detail-item">
                                <strong>Service:</strong><br>
                                ${train.serviceId}
                            </div>
                            <div class="detail-item">
                                <strong>Status:</strong><br>
                                <span class="status-badge status-${train.statusClass}">${train.statusText}</span>
                            </div>
                        </div>

                        ${train.destination ? `
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef; font-size: 0.9rem; color: #6c757d;">
                                <strong>🎯 Calling at:</strong> ${train.destination}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                this.showResults(`
                    <div class="card">
                        <div class="card-header">
                            <h3>🚂 ${this.currentRoute.name}</h3>
                        </div>
                        <div class="card-body">
                            ${trainsHtml}

                            <div class="info-panel">
                                <div class="info-grid">
                                    <div class="info-item">
                                        <strong>📡 Data Status:</strong>
                                        Fresh from RTT API
                                    </div>
                                    <div class="info-item">
                                        <strong>⚡ Fetch Speed:</strong>
                                        ${fetchTime}ms
                                    </div>
                                    <div class="info-item">
                                        <strong>🕒 Updated:</strong>
                                        ${this.lastFetchTime.toLocaleTimeString()}
                                    </div>
                                    <div class="info-item">
                                        <strong>🌐 Method:</strong>
                                        ${this.apiMethod}
                                    </div>
                                </div>

                                <div class="cost-highlight">
                                    <strong>💰 Zero-Cost Solution:</strong> This data was fetched on-demand when you clicked refresh. 
                                    No scheduled updates, no hosting fees, no API limits - completely free forever!
                                </div>

                                <button class="btn btn-success" onclick="trainTracker.fetchLiveData()" style="margin-top: 1rem;">
                                    ⚡ Refresh for Latest
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            }

            formatTrain(service) {
                const detail = service.locationDetail || {};

                const scheduled = this.formatTime(detail.gbttBookedDeparture || detail.workingDeparture);
                const realtime = this.formatTime(detail.realtimeDeparture);
                const expected = realtime || scheduled;

                let statusClass = 'success';
                let statusText = 'On time';

                if (detail.cancelled) {
                    statusClass = 'error';
                    statusText = 'Cancelled';
                } else if (expected && expected !== scheduled) {
                    const delay = this.timeDiff(scheduled, expected);
                    if (delay > 0) {
                        statusClass = 'warning';
                        statusText = `Delayed ${delay}m`;
                    } else if (delay < 0) {
                        statusClass = 'success';
                        statusText = `Early ${Math.abs(delay)}m`;
                    }
                }

                return {
                    scheduledTime: scheduled || 'TBA',
                    expectedTime: expected || scheduled || 'TBA',
                    platform: detail.platform || 'TBA',
                    operator: service.atocName || 'Unknown',
                    serviceId: service.trainIdentity || service.serviceUid?.slice(-4) || 'Unknown',
                    destination: detail.destination?.map(d => d.description).join(', ') || null,
                    statusClass,
                    statusText
                };
            }

            formatTime(timeStr) {
                if (!timeStr || timeStr.length !== 4) return null;
                return `${timeStr.slice(0, 2)}:${timeStr.slice(2)}`;
            }

            timeDiff(time1, time2) {
                if (!time1 || !time2) return 0;
                const [h1, m1] = time1.split(':').map(Number);
                const [h2, m2] = time2.split(':').map(Number);
                return (h2 * 60 + m2) - (h1 * 60 + m1);
            }

            showErrorState(error) {
                this.showResults(`
                    <div class="card">
                        <div class="card-header">
                            <h3>❌ Connection Error</h3>
                        </div>
                        <div class="card-body">
                            <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
                                <strong>Error:</strong> ${error.message}
                            </div>

                            <h4>🔧 Troubleshooting:</h4>
                            <ol style="margin: 1rem 0; padding-left: 2rem;">
                                <li>Check your internet connection</li>
                                <li>Try the "Test Connection" button</li>
                                <li>Wait a moment and try again</li>
                                <li>Try a different route</li>
                            </ol>

                            <div class="control-group">
                                <button class="btn btn-success" onclick="trainTracker.fetchLiveData()">
                                    🔄 Try Again
                                </button>
                                <button class="btn btn-secondary" onclick="trainTracker.testConnection()">
                                    🔧 Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            }

            async testConnection() {
                const testBtn = document.getElementById('test-btn');
                testBtn.disabled = true;
                testBtn.textContent = '🔄 Testing...';

                this.showStatus('🔄 Testing API connection...', 'testing');

                try {
                    await this.callTrainAPI('WFJ', 'EUS');
                    this.showStatus(`✅ Connection working via ${this.apiMethod}`, 'working');
                } catch (error) {
                    this.showStatus(`❌ Connection failed: ${error.message}`, 'failed');
                } finally {
                    testBtn.disabled = false;
                    testBtn.textContent = '🔧 Test Connection';
                }
            }

            showStatus(message, type) {
                const statusEl = document.getElementById('api-status');
                const messageEl = document.getElementById('api-message');

                messageEl.textContent = message;
                statusEl.className = `api-status ${type}`;
                statusEl.classList.remove('hidden');
            }

            showResults(html) {
                document.getElementById('results').innerHTML = html;
            }
        }

        // Initialize
        let trainTracker;
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚂 Starting Live Train Tracker...');
            trainTracker = new LiveTrainTracker();
        });
    </script>
</body>
</html>